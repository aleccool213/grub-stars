name: Deploy Test Environment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Fly.io Test
    runs-on: ubuntu-latest
    # Only deploy if tests pass
    needs: []

    steps:
      - name: Check for Fly.io API token
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "=============================================="
            echo "  FLY_API_TOKEN secret is not configured!"
            echo "=============================================="
            echo ""
            echo "To enable automatic deployments, follow these steps:"
            echo ""
            echo "1. Install the Fly.io CLI (if not already installed):"
            echo "   curl -L https://fly.io/install.sh | sh"
            echo ""
            echo "2. Login to Fly.io:"
            echo "   fly auth login"
            echo ""
            echo "3. Create a deploy token:"
            echo "   fly tokens create deploy -x 999999h"
            echo ""
            echo "4. Add the token to GitHub:"
            echo "   - Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   - Click 'New repository secret'"
            echo "   - Name: FLY_API_TOKEN"
            echo "   - Value: (paste the token from step 3)"
            echo "   - Click 'Add secret'"
            echo ""
            echo "5. Re-run this workflow or push a new commit to main"
            echo ""
            echo "=============================================="
            exit 1
          fi
          echo "FLY_API_TOKEN is configured"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create app if not exists
        run: |
          if ! flyctl apps list | grep -q "grub-stars-test"; then
            echo "Creating grub-stars-test app..."
            flyctl apps create grub-stars-test --org personal || true
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Create volume if not exists
        run: |
          if ! flyctl volumes list --config fly.test.toml 2>/dev/null | grep -q "grub_stars_test_data"; then
            echo "Creating persistent volume..."
            flyctl volumes create grub_stars_test_data --size 1 --region ord --config fly.test.toml --yes || true
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --config fly.test.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Create Sentry release
        if: success()
        run: |
          echo "Creating Sentry release for test deployment..."
          curl -sL https://sentry.io/get-cli/ | bash
          export SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}"
          export SENTRY_ENVIRONMENT="test"
          ./scripts/sentry-release.sh "${{ github.sha }}"
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: Show deployment URL
        run: |
          echo "âœ… Deployment complete!"
          echo "App URL: https://grub-stars-test.fly.dev"
